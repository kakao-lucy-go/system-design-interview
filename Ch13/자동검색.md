# 

구글 검색창에 단어를 입력했을 때 자동완성되는 검색어 표현하기

## 1. 요구사항

1. 사용자가 입력하는 부분이 자동완성 검색어의 첫 부분이다.
2. 자동완성 검색어가 5개가 표시되어야 한다.
3. 질의 빈도에 따라 정해지는 인기 순위를 기준으로 검색한다.
4. 맞춤법이나 자동수정은 지원하지 않는다.
5. 질의는 영어 소문자로 이루어지고, 다국어는 선택이다.
6. 일간 능동 사용다는 천만명이다.
7. 응답속도는 100ms이다.

→ 계산 결과는 정렬되어있어야 하고, 트래픽에 따라 확장 가능해야 한다.

### 1.1 규모 추정

1. 일간 능동 사용 사용자는 천만명이다.
2. 평균적으로 한 사용자는 매일 10건을 검색한다.
3. 질의할 때마다 20바이트정도를 입력한다. 1문자가 1바이트이고 보통 5글자로 이루어진 4개의 단어를 입력한다.
4. 글자를 입력할 때마다 백엔드에 요청을 보낸다. 즉, 1회 검색당 20건의 요청이 전달된다.
5. 천만 사용자 * 10건 검색 / 20바이트 질의 / 24시간 / 3600초 = 48,000QPS. 즉, 초당 48,000건의 질의를 한다. 
6. 질의를 하면 데이터를 등록한다는 의미이고, 20%가 신규 검색이라고 생각하면 (천만 사용자 * 10건의 질의 / 일 * 20자 * 20%) 매일 0.4g 정도가 추가된다.

## 2. 설계안 제시

- 데이터 수집 서비스 : 질의 데이터를 수집
    - 질의문과 사용빈도를 저장하는 빈도 테이블
- 질의 서비스 : 5개의 인기 검색어를 정렬해서 내놓음
    - 위의 빈도 테이블에서 검색한다. (라는건 단어를 저장하겠다는 건데 그럼 위에서 왜 20자를 곱했을까?)

## 3. 상세 설계

- 최적화
    - 트라이 자료구조
        - 트라이는 문자열을 간략히 저장할 수 있는 자료구조다.
        - 트리 형태의 자료구조다
        - 루트노트는 빈 문자열이다
        - 각 노드는 글자 하나를 저장하며 26개의 자식을 가질 수 있다.
        - 각 트리 노드는 단어 혹은 접두어 문자열을 나타낸다.
        - 문제: 전체 트라이를 다 검색해야할 수도 있다.
            - 접두어 최대 길이 제한
            - 각 노드에 인기 검색어를 캐시
                - 각 노드에 질의어를 저장할 공간이 많이 필요하다.
                - 하지만 응답 속도가 빠르다.
    - 데이터 수집 서비스
        - 실시간으로 데이터를 수집하면 느리고, 인기 검색어는 잘 바뀌지 않는다.
        - 실시간으로 바꿔줄 이유가 없다.
            - 데이터 분석 서비스 로그: 검색 원본 데이터 보관. 수정하지 않고 인덱스도 걸지 않음
            - 로그 취합 서버
            - 작업 서버는 주기적으로 비동기 작업으로 트라이 자료구조와 디비를 만든다.
            - 매주 트라이 디비에서 스냅샷을 떠서 캐시한다.
            - 트라이 디비
                - 문서 저장소가 유리할 수 있다(MongoDB)
                - 키-값 저장소를 사용할 수도 있다.
    - 질의 서비스
        - 질의가 로드밸런서로 전송된다.
        - 로드밸런서는 API로 전달한다.
        - API 서버는 트라이 캐시에서 데이터를 가져온다.
            - 캐시에 없으면 디비에서 가져와 채운다.
        - FE는 새로고침할 필요없게 요청한다.
        - 브라우저에 캐싱한다. (ttl 존재해야함)
        - 전부를 로깅하면 자원을 너무 많이 쓰므로 요청 가운데 1개만 로깅(샘플링)한다.
        - 트라이 연산
            - 트라이 생성
            - 개신(매주 갱신)
            - 필터 계층을 앞에 둬서 데이터를 삭제해서 부적절한 질의어가 반환되지 않도록 한다
    - 규모 확장이 가능한 저장소
        - 첫글자를 기준으로 샤딩한다. (a~i까지는 1번서버 이런식으로)
            - 최대 알파벳 수 26대
            - 이 이상으로 늘리려면 두번째 글자수부터 해서 계층적으로 샤딩한다.
            - 단, 균등하게 배분하기 어렵다.
            - 그래서 샤드 관리자가 패턴을 분석해서 샤딩한다.
    - 트라이 연산

## 마무리

1. 다국어 지원
    1. 트라이에 유니코드 데이터 저장..
2. 국가별 순위
    1. 국가별 트라이를 CDN에 저장 
3. 실시간 변경 반영 
    1. 최근 검색어에 가중치를 준다.
    2. 하둡같이 데이터를 스트림 형태로 관리한다.
    3. 샤딩으로 작업 대상 데이터 양을 줄인다
