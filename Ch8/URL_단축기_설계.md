# 8장 URL 단축기 설계

## 8.1 1단계 문제 이해 및 설계 범위 확정

- URL 단축기 동작 방식
- 트래픽 규모
- 단축 URL 의 길이
- 문자에 대한 제한
- URL의 삭제와 갱신 여부

### 8.1.1 개략적 추정

- 쓰기 연산: 매일 1억개 단축 URL 생성
- 초당 쓰기 연산 1억/24/3600 = 1160
- 읽기 연산: 초당 11,600회
- 10년간 운영해서 3650억개의 레코드 보관
- 축약 전 URL의 평균 길이는 100
- 10년동안 쓰는 저장 용량은 36.5 TB

## 8.2 개략적 설계안 제시 및 동의 구하기

### 8.2.1 API 엔드포인트

1. URL 단축용 엔드포인트 
    1. POST /api/v1/data/shorten
2. URL 리다이렉션용 엔드포인트: 단축 URL 요청이 오면 원래 URL 로 보내주기 위한 용도
    1. GET /api/v1/shorten

### 8.2.2 URL 리디렉션

단축URL을 받은 서버는 원래 URL 로 바꿔서 301응답의 Location 헤더에 넣어 반환한다.

- 301 Permanently Moved: 해당 URL 에 대한 요청의 처리 책임이 Location 헤더에 반환된 URL 로 영구적으로 이전되었다. 브라우저는 이를 캐시했다가 추후 같은 요청을 보낼 때 캐시된 원래 URL 로 요청을 보낸다. 서버 부하를 줄인다.
- 302 Found: 일시적으로 Location 헤더가 지정하는 URL 에 의해 처리되어야 한다. 언제나 단축 URL 서버에 보내진다음에 리디렉션한다. 트래픽 분석을 할 때(클릭 발생률이나 발생 위치 추적) 유리.

URL 리디렉션을 구현하는 가장 직관적인 방법은 해시 테이블을 사용하는 것이다.

### 8.2.3 URL 단축

긴 URL을 해시 값으로 대응시킬 해시 함수를 찾아야 한다.

- 긴 URL이 다른 값이면 해시 값도 달라져야 한다.
- 계산된 해시 값은 원래 입력으로 주어졌던 긴 URL로 복원될 수 있어야 한다.

## 8.3 3단계 상세 설계

### 8.3.1 데이터 모델

해시 테이블 전략은 초기엔 좋지만 메모리는 유한하고 비싸기 때문에 <단축 URL, 원래 URL> 쌍을 관계형 디비에 저장한다.

### 8.3.2 해시 함수

원래 URL → 단축 URL로 변환할 때 쓰임 

#### 해시 값 길이 

n=7이면 3.5조의 URL 을 만들 수 있다. [0-9, a-z, A-Z] 의 문자 62개의 n승으로 만들 수 있다.

#### 해시 후 충돌 해소 

7글자 문자열로 줄이는 해시 함수로, CRC32, SHA-1 등을 사용할 수 있다. 하지만 이도 7보다는 길어서 첫 7글자를 이용하는 방법이 있지만 충돌할 하ㅗㄱ률이 높아진다. 이 때는 해소될 떄까지 사전에 정한 문자열을 해시 값에 덧붙인다. 하지만 디비에 매번 물어봐서 질의를 해야해서 블룸 필터를 사용해서 성능을 높일 수 있다.

#### base-62 변환 

62진법은 hashValue에 사용할 수 있는 문자 개수가 62이기 때문이다.

진법 변환은 흔히 사용되는데 수의 표현 방식이 다른 두 시스템이 같은 수를 공유해야 할 때 유용하다.

- 62진법은 수로 표현하기 위해 62개의 문자를 사용하는 진법으로 10~는 소문자로, 36부터는 대문자로 대응시켜 표현한다.

#### 두 접근법 비교(Q. Id가 왜 나오지? → A. Id를 62진법으로 바꾸기 떄문인듯.)

| 해시 후 충돌 해소 | base-62 변환 |
| --- | --- |
| 단축 URL 의 길이 고정 | 가변적. ID값이 커지만 같이 길어짐 |
| 유일성이 보장되는 ID 생성기가 필요하지 않다. | 유일성이 보장되는 ID 생성기가 필요하다. |
| 충돌 발생 가능 | 충돌 불가능. ID의 유일성이 보장되어야 적용 가능하기 때문  |
| 다음에 쓸 URL을 알아내는 것이 불가능 | auto_increment라면 다음 ID를 알아내서 다음 URL 을 알아낼 수 있다. |

### 8.3.3 URL 단축기 상세 설계

1. 입력으로 긴 URL을 받는다.
2. 디비에 해당 URL 이 있는지 검사한다.
3. 있다면 단축 URL 을 만들어 반환한다.
4. 없다면 유일한 ID(디비의 기본 키)를 가져와서 62진법으로 변환해서 이 아이디를 단축 URL로 만든다.
5. ID, 단축 URL, 원래 URL을 디비에 저장한다.

### 8.3.4 URL 리디렉션 상세 설계

로드밸런서의 동작 흐름

1. 사용자가 단축 URL을 클릭한다.
2. 로드밸런서가 요청을 웹 서버에 전달한다.
3. 이미 캐시에 있다면 바로 원래 URL을 꺼내서 전달한다.
4. 캐시에 없다면 디비에서 꺼낸다. 디비에 없다면 잘못된 URL을 입력한 것으로 판단한다.
5. 꺼낸 값을 캐시에 넣고 사용자에게 반환한다.

## 8.4 4단계 마무리

- 처리율 제한 장치: 엄청난 양의 단축 요청이 들어오면 무력화 될 수 있다는 보안 결함이 있어서 처리율 제한 장치를 두고 IP 주소를 필터링한다거나 해서 보안 결함을 보완할 수 있다.
- 웹 서버의 규모 확장: 웹 계층은 무상태 계층이므로 웹 서버를 자유로이 증설하거나 삭제할 수 있다.
- 디비의 규모 확장: 다중화나 샤딩으로 규모를 확장할 수 있다.
- 데이터 분석 솔루션: URL 단축기에 분석 솔루션을 달아서 얼마나 많은 사용자가 클릭했고 언제했는제 알 수 있다.
- 가용성, 일관성, 안정성
