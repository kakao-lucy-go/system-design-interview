# 4장 처리율 제한 장치의 설계

네트워크 시스템에서 처리율 제한 장치는 클라이언트 또는 서비스가 보내는 트래픽의 처리율을 제어하기 위한 장치다. 예를들어 HTTP에서는 특정 기간 내에 전송되는 클라이언트의 요청 횟수를 제한한다. 요청 횟수가 임계치(threshold)를 넘어서면 block 된다.

- 사용자는 초당 2회 이상 새 글을 올릴 수 없다.
- 같은 IP 주소로는 하루에 10개 이상의 계정을 생성할 수 없다.
- 같은 디바이스로는 주당 5회 이상 리워드를 요청할 수 없다.

API 에 처리율 제한 장치를 두면 좋은 점이 3가지가 있다.

1. Dos(Denial Of Service) 공격에 의한 자원 고갈을 방지한다. 예를 들어 트위터는 3시간 동안 300개의 트윗만 올릴 수 있도록 제한하고 있고, 구글 닥스는 분당 300회의 read 요청만 허용한다.
2. 비용을 절감한다. 추가 요청에 대한 처리를 제한하면 서버를 많이 두지 않아도 되고, 우선 순위가 높은 API 에 더 많은 자원을 할당할 수 있다. 이는 써드 파티에 사용료를 지불하는 회사에겐 특히 유용하다.
3. 서버 과부하를 막는다. 봇에서 오는 트래픽이나 잘못된 이용으로 유발된 트래픽을 걸러낼 수 있다.

## 4.1. 1단계: 문제 이해 및 설계 범위 확정

1. 클라이언트 측 제한 장치인지, 서버 측 제한 장치인지
2. IP 주소 기준인지, 사용자 ID가 기준인지 
3. 시스템의 규모는?
4. 분산 환경에서 동작해야하는지?
5. 독립된 서비스인지? 아니면 애플리케이션 코드에 포함되는지?
6. 걸러졌다면 사용자에게 사실을 알려야하는지?

### 4.1.1. 요구사항

1. 설정된 처리율을 초과하는 요청은 제한한다.
2. 빠른 응답 
3. 가능한 한 적은 메모리 사용
4. 분산형 처리율 제한 : 하나의 처리율 제한 장치를 여러 서버나 프로세스에 공유할 수 있다.
5. 예외 처리 : 요청이 제한된 경우 사용자에게 노티 
6. 높은 결함 감내성 : 제한 장치에 장애가 생겨도 전체 시스템에 영향을 주어서는 안된다.

## 4.2. 2단계: 개략적 설계안 제시 및 동의 구하기

### 4.2.1. 처리율 제한 장치는 어디에 둘 것인가?

- 클라이언트 측에 둔다면 : 클라이언트 요청은 쉽게 위변조가 가능하기 때문에 어려울 수 있다.
- 서버 측에 둔다면:
    - API 서버에 둔다.
    - 처리율 제한 미들웨어를 만들어서 미들웨어가 통제 - 429(Too many requests) 반환

보통 MSA의 경우는 API 게이트웨이가 이를 구현하는 미들웨어다. 처리율 제한, SSL 종단, 사용자 인증, IP 허용 목록 관리 등을 한다. 

그렇다면 처리율 제한 장치는 어디에 두어야 할까?

- 현재 사용하는 기술 스택이 서버 측 구현을 지원하는지
- 니즈에 맞는 처리율 제한 알고리즘을 찾는다.
- MSA라면 게이트웨이가 이를 구현할 수 있다.

### 4.2.2. 처리율 제한 알고리즘

#### 4.2.2.1. 토큰 버킷 알고리즘 

간단하고, 보편적인 알고리즘 

동작원리는 다음과 같다.

#### 4.2.2.2. 누출 버킷 알고리즘 

#### 4.2.2.3 고정 윈도 카운터 알고리즘 

#### 4.2.2.4 이동 윈도 로그 알고리즘 

#### 4.2.2.5 이동 윈도 카운터 알고리즘
